---
title: "Next.js App Router: JWT ã‚¯ãƒƒã‚­ãƒ¼èªè¨¼ã®å®Ÿè£…ãƒãƒƒã‚«ã‚½ãƒ³ãƒ¡ãƒ¢"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nextjs, approuter, jwt, jose]
published: true
publication_name: "ka_projects"
---

## ã¯ã˜ã‚ã«

ã“ãªã„ã å‚åŠ ã—ãŸãƒãƒƒã‚«ã‚½ãƒ³ã§å¾—ãŸçŸ¥è¦‹ã®å‚™å¿˜éŒ²ã§ã™ã€‚

## 1\. JWT ç™ºè¡Œã¨ HttpOnly ã‚¯ãƒƒã‚­ãƒ¼è¨­å®š

èªè¨¼ã®åŸºæœ¬ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦ã€ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ API ã§ JWT ã‚’ç™ºè¡Œã—ã€XSS å¯¾ç­–ã®ãŸã‚`HttpOnly`å±æ€§ã‚’ä»˜ä¸ã—ãŸã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜ã™ã‚‹ã€‚

**`/api/auth/register/route.ts`**

```ts
import jwt from "jsonwebtoken";
import { NextResponse } from "next/server";

export async function POST(request: NextRequest) {
  // ... ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå‡¦ç† ...
  const newUser = {
    id: "1",
    email: "test@test.com",
    username: "Test",
    user_id: "test_123",
  };

  const token = jwt.sign(
    {
      id: newUser.id,
      email: newUser.email,
      username: newUser.username,
      userId: newUser.user_id,
    },
    process.env.JWT_SECRET!,
    { expiresIn: "7d" }
  );

  const response = NextResponse.json({ message: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæˆåŠŸ" });

  response.cookies.set("auth-token", token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    maxAge: 60 * 60 * 24 * 7, // 7æ—¥é–“
  });

  return response;
}
```

---

## 2\. èªè¨¼ä»˜ã`fetch`ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã®`fetch`

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®`fetch`ã§ Cookie ã‚’é€ä¿¡ã™ã‚‹ã«ã¯`credentials: 'include'`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚

```tsx
// Client Componentå†…
const res = await fetch("/api/posts", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ content: "æ–°ã—ã„æŠ•ç¨¿ã§ã™" }),
  credentials: "include", // Cookieã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã‚ã‚‹
});
```

### ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã®`fetch`

ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å†…éƒ¨ API ã¸ã®`fetch`ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ Cookie ã¯è‡ªå‹•ã§å¼•ãç¶™ãŒã‚Œãªã„ã€‚`next/headers`ã®`headers()`ã‚’ä½¿ã„ã€ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’æ‰‹å‹•ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã€‚

```tsx
// Server Componentå†…
import { headers } from "next/headers";

const requestHeaders = new Headers(headers());

const res = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/posts`, {
  cache: "no-store",
  headers: requestHeaders, // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¼•ãç¶™ã
});
```

---

## 3\. ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®èªè¨¼æƒ…å ±å–å¾—

`fetch`ã‚’ä»‹ã•ãšã«ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ç›´æ¥èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹å ´åˆã€`next/headers`ã®`cookies()`ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```tsx
// Server Componentå†…
import { cookies } from "next/headers";
import { verifyAuthToken } from "@/lib/auth"; // è‡ªä½œã®æ¤œè¨¼é–¢æ•°

const cookieStore = await cookies();
const token = cookieStore.get("auth-token")?.value;
const user = token ? verifyAuthToken(token) : null;
```

---

## 4\. Middleware ã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒˆä¿è­·

### JWT ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é¸å®š (`jose` vs `jsonwebtoken`)

Middleware ã¯ Edge Runtime ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€Node.js API ã«ä¾å­˜ã™ã‚‹`jsonwebtoken`ã¯ç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚Edge äº’æ›ã®`jose`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ã€‚

### `middleware.ts`ã®å®Ÿè£…

æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚„ã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãªã©ã‚’ä¸€å…ƒçš„ã«è¡Œã†ã€‚

```ts
// middleware.ts
import { NextRequest, NextResponse } from "next/server";
import { jwtVerify } from "jose";

const AUTH_PATHS = ["/login", "/signup"];
const SECRET = new TextEncoder().encode(process.env.JWT_SECRET!);

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  const token = request.cookies.get("auth-token")?.value;

  // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆ
  const isAuthPath = AUTH_PATHS.some((path) => pathname.startsWith(path));
  if (isAuthPath) {
    if (token) {
      try {
        await jwtVerify(token, SECRET);
        return NextResponse.redirect(new URL("/", request.url));
      } catch (error) {
        /* ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãªã‚‰ä½•ã‚‚ã—ãªã„ */
      }
    }
    return NextResponse.next();
  }

  // ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆ
  if (!token) {
    return NextResponse.redirect(new URL("/login", request.url));
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚ã‚‹ãŒã€ç„¡åŠ¹ãªå ´åˆ
  try {
    await jwtVerify(token, SECRET);
    return NextResponse.next();
  } catch (err) {
    return NextResponse.redirect(new URL("/login", request.url));
  }
}

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};
```

&nbsp;
&nbsp;
&nbsp;
&nbsp;
ä»¥ä¸Šã§ã™ã€‚
