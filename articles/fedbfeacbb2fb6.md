---
title: "Jestã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆè¨­è¨ˆã®åŸºæœ¬ã¨å®Ÿè·µ"
emoji: "ğŸ‰"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [jest, msw, graphql, test]
published: true
publication_name: "ka_projects"
published_at: 2025-05-28 09:00
---

# 1. Jest ã¨ã¯

Jest ã¯ã€Facebook ç¤¾ãŒé–‹ç™ºã—ãŸ JavaScript ç”¨ã®ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®šã§åˆ©ç”¨ã§ãã‚‹ä¸€æ–¹ã€ãƒ¢ãƒƒã‚¯ã‚„ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ãªã©ã®é«˜åº¦ãªæ©Ÿèƒ½ã‚‚å‚™ãˆã¦ã„ã¾ã™ã€‚

Jest ã®ä¸»ãªç‰¹å¾´ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

- ã‚¼ãƒ­ã‚³ãƒ³ãƒ•ã‚£ã‚°ï¼šè¨­å®šãªã—ã§ã™ãã«ä½¿ç”¨é–‹å§‹ã§ãã‚‹
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼šUI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´ã‚’æ¤œå‡º
- ãƒ¢ãƒƒã‚¯æ©Ÿèƒ½ï¼šå¤–éƒ¨ä¾å­˜ã®åˆ¶å¾¡ã¨åˆ†é›¢
- ä¸¦è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼šé«˜é€Ÿãªå®Ÿè¡Œç’°å¢ƒ
- ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆï¼šãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§ç¢ºèª

# 2. ãƒ†ã‚¹ãƒˆè¨­è¨ˆã®è€ƒãˆæ–¹

## 2.1 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—æ–¹

åŠ¹æœçš„ãªãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã‚ã«ã¯ã€é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ´—ã„å‡ºã™ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãƒ†ã‚¹ãƒˆç‚¹ã‚’æ±ºã‚ã‚‹éš›ã¯ã€ä¸»ã«ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆã«ç€ç›®ã—ã¾ã™ï¼š

### A. æ¡ä»¶åˆ†å²ã®çµæœãŒå¤‰ã‚ã‚‹ç®‡æ‰€

ã‚³ãƒ¼ãƒ‰å†…ã§çµæœãŒå¤‰ã‚ã‚‹åˆ†å²ç‚¹ã‚’ãƒ†ã‚¹ãƒˆå¯¾è±¡ã«ã—ã¾ã™ï¼š

- `if (isUserPremium) { return true; }` ã®ã‚ˆã†ãªæ˜ç¤ºçš„ãªåˆ†å²
- ä¸‰é …æ¼”ç®—å­ `condition ? valueA : valueB` ã«ã‚ˆã‚‹æš—é»™çš„ãªåˆ†å²
- è«–ç†æ¼”ç®—å­ `value || defaultValue` ã«ã‚ˆã‚‹çŸ­çµ¡è©•ä¾¡

ã“ã‚Œã‚‰ã®åˆ†å²ã”ã¨ã«ã€ç•°ãªã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

### B. å¢ƒç•Œå€¤ã¨ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

ãƒã‚°ã¯å¢ƒç•Œæ¡ä»¶ã§ç™ºç”Ÿã—ã‚„ã™ã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¢ƒç•Œå€¤ã«æ³¨ç›®ã—ã¾ã™ï¼š

- æ•°å€¤ãŒ 0 ã‹ 1 ä»¥ä¸Šã‹ï¼ˆã¾ãŸã¯è² ã®å€¤ã¸ã®å¯¾å¿œï¼‰
- é…åˆ—ãŒç©ºã‹è¦ç´ ãŒã‚ã‚‹ã‹
- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ`null`/`undefined`ã‹æœ‰åŠ¹ãªå€¤ã‹
- æ—¥ä»˜ãŒç‰¹å®šã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ã¾ãŸãã‚±ãƒ¼ã‚¹

## 2.2 å¤–éƒ¨ä¾å­˜ã®æœ‰ç„¡ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆè¨­è¨ˆã®é•ã„

ãƒ†ã‚¹ãƒˆè¨­è¨ˆã¯å¯¾è±¡é–¢æ•°ã®ç‰¹æ€§ã«ã‚ˆã£ã¦å¤§ããç•°ãªã‚Šã¾ã™ï¼š

| ç‰¹æ€§     | å¤–éƒ¨ä¾å­˜ãªã—ï¼ˆç´”ç²‹é–¢æ•°ï¼‰ | å¤–éƒ¨ä¾å­˜ã‚ã‚Šï¼ˆãƒ•ãƒƒã‚¯ã€API é€šä¿¡ãªã©ï¼‰ |
| -------- | ------------------------ | ------------------------------------ |
| è¤‡é›‘ã•   | ã‚·ãƒ³ãƒ—ãƒ«                 | è¤‡é›‘                                 |
| è¨­è¨ˆæ–¹æ³• | å…¥åŠ›ã¨å‡ºåŠ›ã®æ¤œè¨¼ã®ã¿     | ãƒ¢ãƒƒã‚¯ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦           |

Jest ã§ãƒ•ãƒƒã‚¯ã‚„å¤–éƒ¨ä¾å­˜ã®ã‚ã‚‹é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€å¤–éƒ¨ã§å®šç¾©ã•ã‚ŒãŸé–¢æ•°ã‚„ãƒ•ãƒƒã‚¯ã®æŒ™å‹•ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ãƒ¢ãƒƒã‚¯ãŒå¿…è¦ã§ã™ã€‚ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å®Ÿéš›ã® API ã‚„ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…ã¯åˆ©ç”¨ã§ããªã„ãŸã‚ã€ã“ã‚Œã‚‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¤ã¾ã‚Šã€å¤–éƒ¨ä¾å­˜ã®ã‚ã‚‹ãƒ†ã‚¹ãƒˆã¯ã€ãŸã ãã®ãƒ•ãƒƒã‚¯ã«å¼•æ•°ã‚’ã½ã„ã¨æŠ•ã’ã‚Œã°è‰¯ã„ã‚ã‘ã§ã¯ãªãã€ä¸­ã§å‹•ã„ã¦ã„ã‚‹å¤–éƒ¨ä¾å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹å‰æº–å‚™ãŒå¿…è¦ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

# 3. ãƒ¢ãƒƒã‚¯ã™ã‚‹éš›ã®æµã‚Œ

2 ã¤ã®ãƒ¢ãƒƒã‚¯ã«ã¤ã„ã¦æ‰±ã„ã¾ã™ã€‚

1. **API ãƒ¢ãƒƒã‚¯ï¼ˆMSWï¼‰**: HTTP å‘¼ã³å‡ºã—ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã—ã¦ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

   æµã‚Œ:

   1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ãŒ API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œ
   2. MSW ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
   3. è¨­å®šã—ãŸãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´

2. **ãƒ•ãƒƒã‚¯ãƒ¢ãƒƒã‚¯ï¼ˆJestï¼‰**: ãƒ•ãƒƒã‚¯è‡ªä½“ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ä»»æ„ã®æˆ»ã‚Šå€¤ã‚’è¨­å®šã™ã‚‹

   æµã‚Œ:

   1. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã« Jest ãŒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
   2. å®Ÿéš›ã®é–¢æ•°/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä»£ã‚ã‚Šã«ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’æä¾›
   3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¯ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œ

åŸºæœ¬ã€API ãªã©ã®éåŒæœŸå‡¦ç†ã®ãƒ¢ãƒƒã‚¯ã¯ MSW ã§è‰¯ã„ã§ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã§ãƒ¢ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹ã®ã§ã€‚
ã§ã€ãã®ãƒ¢ãƒƒã‚¯ã—ãŸã‚‚ã®ã‚’ Jest ã®ãƒ†ã‚¹ãƒˆã§å‘¼ã³å‡ºã—ã¦ä½¿ã†ã§å•é¡Œãªã„ã®ã§ã™ãŒã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ mutation ã‚’ MSW ã§ãƒ¢ãƒƒã‚¯ã™ã‚‹ã¨ã€å¤–éƒ¨ã‹ã‚‰ã®å‰¯ä½œç”¨ã§ CI ä¸Šã§ãƒ†ã‚¹ãƒˆãŒè½ã¡ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ã‚‰ã—ã„ã§ã™ã€‚ãã®å ´åˆã¯ Jest ã«ã‚ˆã‚‹ãƒ¢ãƒƒã‚¯ã§å¯¾å¿œã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚

ãã‚Œãã‚Œè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## 3.1 ãƒ¢ãƒƒã‚¯ by Jest

æ‰‹é †ã¨ã—ã¦ã¯ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’ä½œæˆã™ã‚‹ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã®è¿”ã™å€¤ã‚’è¨­å®šã™ã‚‹ã€ã¨ã„ã†æµã‚Œã§ã™ã€‚

### A. ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’ä½œæˆã™ã‚‹æ–¹æ³•

**â‘  jest.fn()**

`jest.fn()`ã¯å€‹åˆ¥ã®é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ï¼š

```jsx
const mockFunction = jest.fn();
```

ã“ã®é–¢æ•°ã¯å‘¼ã³å‡ºã—å›æ•°ã‚„å¼•æ•°ã‚’è¿½è·¡ã§ãã€ãƒ†ã‚¹ãƒˆå†…ã§å‘¼ã³å‡ºã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

**â‘¡ jest.mock()**

`jest.mock()`ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã—ã¾ã™ï¼š

```jsx
jest.mock('@/utils/api', () => ({
  fetchData: jest.fn()
})
```

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ç‚¹ã§ç½®ãæ›ãˆãŒè¡Œã‚ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ãŒä¾å­˜ã™ã‚‹ã™ã¹ã¦ã®å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚

**â‘¢ jest.requireActual()**

éƒ¨åˆ†çš„ãªãƒ¢ãƒƒã‚¯ã‚’è¡Œã†å ´åˆã«ã€å…ƒã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ï¼š

```jsx
jest.mock("@/utils/helpers", () => {
  return {
    ...jest.requireActual("./utils/helpers"), // å…ƒã®å®Ÿè£…ã‚’ä¿æŒ
    getCurrentDate: jest.fn(), // ã“ã®é–¢æ•°ã ã‘ç½®ãæ›ãˆ
  };
});
```

### B. ãƒ¢ãƒƒã‚¯é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•

ã¾ãšã¯ãƒ¢ãƒƒã‚¯ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚

**â‘  require()**

```jsx
jest.mock("@/hooks/userData", () => ({
  useData: jest.fn(),
}));

// ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å†…ã§å‹•çš„ã«å¤‰æ›´
it("ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ä¸­ã®å ´åˆ", () => {
  require("@/hooks/userData").useData.mockReturnValue({
    loading: true,
    data: null,
  });
  // ãƒ†ã‚¹ãƒˆå†…å®¹...
});
```

**â‘¡ jest.spyOn()**

```jsx
import * as userDataHooks from "@/hooks/userData";

jest.mock('@/hooks/userData', () => ({
  useData: jest.fn()}));

it('ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ä¸­ã®å ´åˆ', () => {
  const selectMainAccountMock = jest.fn();
  jest.spyOn(userDataHooks, "useData").mockReturnValue({
    isPending: false,
    mutate: selectMainAccountMock,
  } as unknown as ReturnType<typeof userDataHooks.useData>);
  ...
});
```

2 è€…ã®é•ã„ã¯ã€

> **1. å‹ã®å®‰å…¨æ€§**
>
> - **require()**: å‹æƒ…å ±ãŒå¤±ã‚ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹
> - **spyOn()**:Â ReturnType<typeof ...>ãªã©ã®å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã§å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ã—ã‚„ã™ã„
>
> **2. ã‚³ãƒ¼ãƒ‰è£œå®Œã¨ IDE ã‚µãƒãƒ¼ãƒˆ**
>
> - **require()**: å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®ãŸã‚ã€IDE ã®ã‚³ãƒ¼ãƒ‰è£œå®Œã‚µãƒãƒ¼ãƒˆãŒå¼±ã„
> - **spyOn()**: é™çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€IDE ã®ã‚³ãƒ¼ãƒ‰è£œå®ŒãŒåŠ¹æœçš„
>
> **3. ãƒ¢ãƒƒã‚¯ã®æ˜ç¤ºæ€§**
>
> - **require()**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‚ç…§å–å¾—ãŒãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å†…ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹
> - **spyOn()**: ãƒ¢ãƒƒã‚¯é–¢æ•°ã®ä½œæˆã‚„ç›£è¦–å¯¾è±¡ãŒæ˜ç¤ºçš„ã§å¯è¦–æ€§ãŒé«˜ã„
>
> **4. é–¢é€£é–¢æ•°ã®åˆ©ç”¨**
>
> - **require()**: å˜ç´”ã«å€¤ã‚’è¨­å®šã™ã‚‹ã ã‘ã®å ´åˆã«ç°¡æ½”
> - **spyOn()**: åŒã˜ãƒ†ã‚¹ãƒˆå†…ã®ä»–ã®ã‚³ãƒ¼ãƒ‰ã§ä½œæˆã—ãŸãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’é€£æºã•ã›ã‚„ã™ã„ï¼ˆä¾‹ï¼šselectMainAccountMockï¼‰

ã¨ã®ã“ã¨ã§ã™ã€‚spyOn ã‚’ä½¿ã£ã¦ãŠã‘ã°è‰¯ã•ãã†ã§ã™ã­ã€‚

### C. ãƒ¢ãƒƒã‚¯ã—ãŸé–¢æ•°ãŒè¿”ã™å€¤ã‚’è¨­å®šã™ã‚‹æ–¹æ³•

**mockReturnValue**, **mockImplementation()**ã¯ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒ¢ãƒƒã‚¯é–¢æ•°ã«å¯¾ã—ã¦ã€è¿”ã™å€¤ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

ä¸¡è€…ã®é•ã„ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

- **mockReturnValue**ï¼šå˜ç´”ãªå›ºå®šå€¤ã‚’è¿”ã™å ´åˆ
  ```jsx
  mockFunction.mockReturnValue(5);
  ```
- **mockImplementation**ï¼šå¼•æ•°ã«ã‚ˆã£ã¦è¿”ã‚Šå€¤ã‚’å¤‰ãˆã‚‹ãªã©ã€æ¡ä»¶ã«ã‚ˆã£ã¦ç•°ãªã‚‹å€¤ã‚’è¿”ã™å ´åˆ
  ```jsx
  mockFunction.mockImplementation((arg) => {
    if (arg === "A") return 10;
    return 20;
  });
  ```

ã¾ãŸã€éåŒæœŸå‡¦ç†ã‚’å«ã‚€æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã¯`mockResolvedValue` / `mockRejectedValue` ã‚’ä½¿ã„ã¾ã™ã€‚

### ãŠã¾ã‘: **clearAllMocks(),** resetAllMocks()

å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å†…ã§æ¯å›`mockReturnValue`ãªã©è¿”ã™å€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ãªã„å ´åˆã€ãƒ¢ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚ãã“ã§ä½¿ã„ã¾ã™ã€‚

2 è€…ã®é•ã„ã¯

- `clearAllMocks()`ã¯ã€2 ã¤ã® assertion é–“ã§ãƒ¢ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸã„éš›ã«ä¾¿åˆ©ã€‚
- `resetAllMocks()`ã¯ã€`clearAllMocks()`ã®å®Ÿè¡Œå†…å®¹ã«åŠ ãˆã¦ã€`return values or implementations`ã‚’å‰Šé™¤å¯èƒ½ã€‚

ã‚‰ã—ã„ã§ã™(å‚è€ƒ: [[Jest] clearAllMocks()ã¨ resetAllMocks()ã®é•ã„ã«ã¤ã„ã¦ç¢ºèªã—ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/jest-the-difference-between-clearallmocks-and-resetallmocks/))

resetAllMocks ä½¿ã£ã¨ã‘ã°é–“é•ã„ãªã•ãã†ã§ã™ã­ã€‚

```jsx
// å„ãƒ†ã‚¹ãƒˆãŒå§‹ã¾ã‚‹å‰ã«å®Ÿè¡Œ
beforeEach(() => {
  jest.resetAllMocks();
});

// å„ãƒ†ã‚¹ãƒˆãŒçµ‚ã‚ã£ãŸå¾Œã«å®Ÿè¡Œ
afterEach(() => {
  jest.resetAllMocks();
});
```

ã“ã‚Œã«ã‚ˆã‚Šãƒ†ã‚¹ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ã‚’æ’é™¤ã—ã€å„ãƒ†ã‚¹ãƒˆã‚’ç‹¬ç«‹ã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚

## 3.2 ãƒ¢ãƒƒã‚¯ by MSW

### 3.2.1 MSW ç‹¬ç‰¹ã®æ–‡æ³•ã¨ä¸»è¦ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

**åŸºæœ¬æ§‹é€ :**

MSW(Mock Service Worker)ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ä»¥ä¸‹ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```tsx
// ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®šç¾©
const handlers = [
  http.get('/api/users', () => {
    return HttpResponse.json({ users: [...] })
  })
];

// ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
const server = setupServer(...handlers);
```

**ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®šç¾©:**

ä¾‹ã¨ã—ã¦ã€GraphQL ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹å ´åˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®šç¾©ã€‚

```tsx
import { graphql } from "msw";

export const fbSdk = graphql.link(`${NEXT_PUBLIC_FB_URL}/api/graphql`);

// åŸºæœ¬å½¢å¼
fbSdk.query<QueryType>(QueryDocument, () => {
  return HttpResponse.json({ data: { ... } })
})

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ä¾‹
fbSdk.mutation<MutationType>(MutationDocument, ({ variables }) => {
  // variablesã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
  return HttpResponse.json({ data: { ... } })
})
```

`fbSdk.query`ã¨`fbSdk.mutation`ã®è©³ç´°ï¼š

- `fbSdk.query<T>` - GraphQL ã®ã‚¯ã‚¨ãƒªï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šï¼‰æ“ä½œã‚’ãƒ¢ãƒƒã‚¯ã—ã¾ã™
  - ç¬¬ä¸€å¼•æ•°ï¼šGraphQL ã®ã‚¯ã‚¨ãƒªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  - ç¬¬äºŒå¼•æ•°ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®šç¾©ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°
- `fbSdk.mutation<T>` - GraphQL ã®ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´ï¼‰æ“ä½œã‚’ãƒ¢ãƒƒã‚¯
  - ã‚¯ã‚¨ãƒªã¨åŒæ§˜ã®æ§‹æ–‡ã ãŒã€é€šå¸¸ã¯`variables`ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šå‡¦ç†
  - ä¾‹ï¼š`({ variables }) => {...}` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å¤‰æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹

å°šã€ä¸Šã§ä½¿ã‚ã‚Œã¦ã„ã‚‹`HttpResponse`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€msw ã®ãƒ¢ãƒƒã‚¯ãŒè¿”ã™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®šç¾©ã§ãã‚‹ã‚‚ã®ã§ã™ï¼š

```tsx
// æ­£å¸¸ç³»ãƒ¬ã‚¹ãƒãƒ³ã‚¹
HttpResponse.json({ data: {...} })

// ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
HttpResponse.json(
  { data: { addTrialBlockListItem: {
    __typename: "UserError",
    message: "ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚",
    code: "BAD_REQUEST",
    fields: [ /* ... */ ],
  }}},
  { status: 400 }
)
```

### 3.2.2 MSW ã‚’ç”¨ã„ãŸ API ãƒ¢ãƒƒã‚¯ã®æµã‚Œ

æ‰‹é †ã¨ã—ã¦ã¯ã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã®è¿”ã™å€¤ã‚’è¨­å®šã™ã‚‹ã€ã¨ã„ã†æµã‚Œã§ã™ã€‚

**A. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®šç¾©**

```tsx
// mocks/handlers/user.ts
export const userHandlers = [
  http.get("/api/users", () => {
    return HttpResponse.json([
      { id: 1, name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼1" },
      { id: 2, name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼2" },
    ]);
  }),
];

// mocks/handlers.ts
export const handlers = [
  ...userHandlers,
  // ä»–ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼...
];
```

**B. ã‚µãƒ¼ãƒãƒ¼è¨­å®š**

```tsx
// mocks/server.ts
import { setupServer } from "msw/node";
import { handlers } from "./handlers";

export const server = setupServer(...handlers);
```

`setupServer`ã®å½¹å‰²ï¼š

- å®šç¾©ã—ãŸã™ã¹ã¦ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä¸€ã¤ã®ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¾ã¨ã‚ã¾ã™
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã—ã€ãƒãƒƒãƒã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è‡ªå‹•çš„ã«å®Ÿè¡Œ
- ã‚µãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ï¼š
  - `server.listen()` - ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’é–‹å§‹
  - `server.close()` - ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
  - `server.resetHandlers()` - ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ†ã‚¹ãƒˆé–“ã®ç‹¬ç«‹æ€§ç¢ºä¿ï¼‰

Jest ç’°å¢ƒã§ã® MSW ã®è¨­å®šæ–¹æ³•ï¼š

```tsx
// jest.setup.ts
import { server } from "@/mocks/server";

// ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«MSWã‚µãƒ¼ãƒãƒ¼ã‚’é–‹å§‹
beforeAll(() => server.listen());

// å„ãƒ†ã‚¹ãƒˆå¾Œã«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ†ã‚¹ãƒˆé–“ã®å¹²æ¸‰ã‚’é˜²æ­¢ï¼‰
afterEach(() => {
  server.resetHandlers();
  // ä»–ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†...
});

// ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
afterAll(() => server.close());
```

ãã—ã¦ã€**jest.config.ts**ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```tsx
const customJestConfig: Config = {
  setupFilesAfterEnv: ["<rootDir>/jest.setup.ts"],
  // ãã®ä»–ã®è¨­å®š...
};
```

`setupFilesAfterEnv`ã¯é‡è¦ãª Jest è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼š

- ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€**ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã€å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰**ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™
- æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å†…ã«è¨˜è¿°ã•ã‚ŒãŸ`beforeAll`ã€`afterEach`ã€`afterAll`ãªã©ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒƒã‚¯ãŒã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«å¯¾ã—ã¦é©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
- ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ä¸€åº¦ã ã‘è©•ä¾¡ã•ã‚Œã€ãã®ä¸­ã§å®šç¾©ã•ã‚ŒãŸãƒ•ãƒƒã‚¯ãŒå„ãƒ†ã‚¹ãƒˆã®é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã¾ã™

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ãŒè‡ªå‹•ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹ã‚ã‘ã§ã™ã€‚

å®Ÿè¡Œç’°å¢ƒï¼ˆNode.js/ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã«ã‚ˆã£ã¦ç•°ãªã‚‹è¨­å®šã‚‚å¯èƒ½ï¼š

```tsx
// mocks/index.ts
export async function initMocks() {
  if (typeof window === "undefined") {
    // Node.jsç’°å¢ƒã§ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
    const { server } = await import("./server");
    server.listen();
  } else {
    // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯Service Workerãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
    const { worker } = await import("./browser");
    await worker.start({ onUnhandledRequest: "bypass" });
  }
}
```

â†‘ ã¿ãŸã„ãªè¨­å®šã‚’æ›¸ã„ã¦ã€

```tsx
// appã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’è¿½åŠ ã™ã‚‹
useEffect(() => {
  async function setupMocks() {
    const { initMocks } = await import("../mocks");
    await initMocks();
    setShouldRender(true);
  }

  if (API_MOCKING) {
    setupMocks();
  }
}, []);
```

ã®ã‚ˆã†ã«ã™ã‚‹ã¨è¨­å®šãŒè‡ªå‹•é©ç”¨ã•ã‚Œã¾ã™ã€‚

**C. ãƒ¢ãƒƒã‚¯ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ä½œæˆ**

```tsx
// REST APIç”¨
export const mockUsers = (customUsers = []) => {
  server.use(
    http.get("/api/users", () => {
      return HttpResponse.json(customUsers);
    })
  );
};

// GraphQLç”¨
export const mockMainAndSubAccounts = (
  override: Partial<
    Record<ProductAbbreviatedName, MainAndSubAccountsQuery>
  > = {}
) => {
  const emptyData = {
    account: null,
    subAccounts: [],
  };
  server.use(
    fbSdk.query<MainAndSubAccountsQuery>(MainAndSubAccountsDocument, () =>
      HttpResponse.json({ data: override.fb ?? emptyData })
    )
  );
};
```

`server.use()`ã¯ç™»éŒ²æ¸ˆã¿ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´ã§ãã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã«ã‚ˆã£ã¦ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å…¥åŠ›ã•ã‚Œã‚‹å€¤ãŒé•ã†ã®ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’ override ã—ã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚

### 3.2.3 å…·ä½“çš„ãªå®Ÿè£…ä¾‹

ä»¥ä¸‹ã¯ã€GraphQL ã§å®Ÿè£…ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã® CRUD æ“ä½œã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ç°¡å˜ãªä¾‹ã§ã™ï¼š

**ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®šç¾©:**

```tsx
// GraphQLã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
export const userSdk = graphql.link('<https://api.example.com/graphql>');

// çŠ¶æ…‹ã¨ã—ã¦ä¿æŒã™ã‚‹ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
let users = [
  {
    id: '1',
    name: 'å±±ç”°å¤ªéƒ',
    email: 'taro@example.com',
    role: UserRole.ADMIN,
    createdAt: '2023-01-01T00:00:00Z'
  },
  ...
];

export const userHandlers = [
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
  userSdk.query(UsersDocument, () => {
    return HttpResponse.json({
      data: {
        users: users
      }
    });
  }),
...
];

// mocks/handlers/index.ts
import { userHandlers } from './user';

export const handlers = [...userHandlers];
```

**ãƒ¢ãƒƒã‚¯ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°:**

```tsx
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§å–å¾—ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
export const mockUsers = (customUsers: User[]) => {
  server.use(
    userSdk.query(UsersDocument, () => {
      return HttpResponse.json({
        data: { users: customUsers },
      });
    })
  );
};
```

å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†æ™‚ã¯ã“ã†ã—ã¾ã™ã€‚

```tsx
// __tests__/components/UserList.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import UserList from '@/components/UserList';
import { mockUsers, resetMockUsers } from '@/mocks/server';
import { UserRole } from '@/generated/graphql';

describe('UserList', () => {
  it('ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’è¡¨ç¤ºã§ãã‚‹ã“ã¨', async () => {
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ãƒ¢ãƒƒã‚¯ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    mockUsers([{
      id: '99',
      name: 'ç‰¹åˆ¥ãªãƒ¦ãƒ¼ã‚¶ãƒ¼',
      email: 'special@example.com',
      role: UserRole.ADMIN,
      createdAt: '2023-12-31T00:00:00Z'
    }]);

    // ã‚ã¨ã¯ã„ã¤ã‚‚é€šã‚Š
    const { result } = renderHook(() => useUserList(), { wrapper });

    await waitFor(() => {
      expect(result.current).toBe(...);
    });
  });
});
```

# 4. å¤–éƒ¨ä¾å­˜ã®ãªã„é–¢æ•°ã®ãƒ†ã‚¹ãƒˆè¨­è¨ˆæ‰‹é †ã¨å…·ä½“ä¾‹

ã¾ãšã€å¤–éƒ¨ä¾å­˜ã®ãªã„ç´”ç²‹é–¢æ•°ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•ã‹ã‚‰èª¬æ˜ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã¯å…¥åŠ›ã«å¯¾ã—ã¦äºˆæ¸¬å¯èƒ½ãªå‡ºåŠ›ã‚’è¿”ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚„å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚

## 4.1 ãƒ†ã‚¹ãƒˆè¨­è¨ˆã®åŸºæœ¬æ‰‹é †

å¤–éƒ¨ä¾å­˜ãŒãªã„é–¢æ•°ã®ãƒ†ã‚¹ãƒˆè¨­è¨ˆã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ï¼š

1. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—**ï¼šé–¢æ•°ã®æ¡ä»¶åˆ†å²ã‚„å¢ƒç•Œå€¤ã‚’ç¢ºèª
2. **å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™**ï¼šå„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å¯¾å¿œã™ã‚‹å…¥åŠ›å€¤ã‚’ç”¨æ„
3. **æœŸå¾…å€¤ã®å®šç¾©**ï¼šå„å…¥åŠ›ã«å¯¾ã—ã¦æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã‚’å®šç¾©
4. **ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ&ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ¤œè¨¼**ï¼šé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€çµæœã¨æœŸå¾…å€¤ã‚’æ¯”è¼ƒ

## 4.2 å…·ä½“ä¾‹ï¼šæ©Ÿèƒ½ã®åˆ©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°

ä»¥ä¸‹ã®ã‚ˆã†ãªå¤–éƒ¨ä¾å­˜ã®ãªã„é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```tsx
// src/utils/subscription.ts
// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã®å®šç¾©
export enum SubscriptionType {
  Free = "free",
  Basic = "basic",
  Standard = "standard",
  Premium = "premium",
}

/**
 * ç‰¹å®šã®æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ç´”ç²‹é–¢æ•°
 * @param subscriptionType ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—
 * @returns æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹
 */
export function isFeatureAvailable(
  subscriptionType?: SubscriptionType | null
): boolean {
  if (!subscriptionType) {
    return false;
  }

  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ä»¥å¤–ã§æ©Ÿèƒ½ä½¿ç”¨å¯èƒ½
  return subscriptionType !== SubscriptionType.Free;
}
```

**ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ä¾‹:**

```tsx
// src/utils/subscription.test.ts
import { isFeatureAvailable, SubscriptionType } from "./subscription";

describe("isFeatureAvailable", () => {
  it("ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ãŒæœªå®šç¾©ã®å ´åˆã€falseã‚’è¿”ã™", () => {
    // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
    const input = undefined;

    // é–¢æ•°å®Ÿè¡Œ
    const result = isFeatureAvailable(input);

    // çµæœã®æ¤œè¨¼
    expect(result).toBe(false);
  });

  it("ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ãŒnullã®å ´åˆã€falseã‚’è¿”ã™", () => {
    const input = null;
    const result = isFeatureAvailable(input);
    expect(result).toBe(false);
  });

  it("ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆã€falseã‚’è¿”ã™", () => {
    const input = SubscriptionType.Free;
    const result = isFeatureAvailable(input);
    expect(result).toBe(false);
  });

  it("åŸºæœ¬ãƒ—ãƒ©ãƒ³ã®å ´åˆã€trueã‚’è¿”ã™", () => {
    const input = SubscriptionType.Basic;
    const result = isFeatureAvailable(input);
    expect(result).toBe(true);
  });

  it("æ¨™æº–ãƒ—ãƒ©ãƒ³ã®å ´åˆã€trueã‚’è¿”ã™", () => {
    const input = SubscriptionType.Standard;
    const result = isFeatureAvailable(input);
    expect(result).toBe(true);
  });

  it("ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã®å ´åˆã€trueã‚’è¿”ã™", () => {
    const input = SubscriptionType.Premium;
    const result = isFeatureAvailable(input);
    expect(result).toBe(true);
  });
});
```

# 5. å¤–éƒ¨ä¾å­˜ã®ã‚ã‚‹ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆè¨­è¨ˆæ‰‹é †ã¨å…·ä½“ä¾‹

æ¬¡ã«ã€å¤–éƒ¨ä¾å­˜ã®ã‚ã‚‹ React ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•ã§ã™ã€‚

## 5.1 ãƒ†ã‚¹ãƒˆè¨­è¨ˆã®è©³ç´°ãªæ‰‹é †

å¤–éƒ¨ä¾å­˜ãŒã‚ã‚‹ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆã§ã®æ‰‹é †ã§ã™ã€‚

1. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—**ï¼šé–¢æ•°ã®æ¡ä»¶åˆ†å²ã‚„å¢ƒç•Œå€¤ã‚’ç¢ºèª
2. **ä¾å­˜é–¢ä¿‚ã®ç‰¹å®š**ï¼šãƒ†ã‚¹ãƒˆå¯¾è±¡ã«ã¾ã¤ã‚ã‚‹ä¾å­˜é–¢ä¿‚ã‚’æ•´ç†
3. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒ¢ãƒƒã‚¯è¨­å®š**ï¼šä¾å­˜é–¢ä¿‚ã®ä¸­ã§ãƒ¢ãƒƒã‚¯ã—ãŸæ–¹ãŒè‰¯ã„ã‚‚ã®ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ãƒ¢ãƒƒã‚¯
4. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å›ºæœ‰ã®ãƒ¢ãƒƒã‚¯è¨­å®š**ï¼šãƒ¢ãƒƒã‚¯é–¢æ•°ã«å¯¾ã—ã¦å€¤ã‚’æŒ¿å…¥
5. **ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ&ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ¤œè¨¼**ï¼šãƒ•ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ã€çµæœã¨æœŸå¾…å€¤ã‚’æ¯”è¼ƒ

### 5.1.1 ä¾å­˜é–¢ä¿‚ã®ç‰¹å®š

ã¾ãšã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ•ãƒƒã‚¯ãŒä¾å­˜ã™ã‚‹ã™ã¹ã¦ã®å¤–éƒ¨è¦ç´ ã‚’ç‰¹å®šã—ã¾ã™ï¼š

- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
- å¤–éƒ¨ API ã‚„ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

### 5.1.2 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒ¢ãƒƒã‚¯è¨­å®š

1 ã§ç‰¹å®šã—ãŸå¤–éƒ¨è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’`jest.mock()`ã‚’ä½¿ã£ã¦ãƒ¢ãƒƒã‚¯åŒ–ã—ã€ãã®ä¸­ã§ãƒ¢ãƒƒã‚¯ã™ã‚‹å¿…è¦ã®ã‚ã‚‹é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã®éš›ã€ãƒ¢ãƒƒã‚¯ã™ã‚‹ç¯„å›²ã¯æœ€ä½é™ã«ã™ã‚‹ã¹ãã§ã™ã€‚

ä¾‹ãˆã°ç´”ç²‹é–¢æ•°ã‚‚ãƒ¢ãƒƒã‚¯ã—ã‚ˆã†ã¨æ€ãˆã°ã§ãã‚‹ã‚“ã§ã™ãŒã€ãã‚“ãªã“ã¨ã›ãšã«é–¢æ•°ã®è¿”ã‚Šå€¤ã‚’ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½œæˆã—ã¦ã‚„ã‚Œã°è‰¯ã„ã§ã™ã‚ˆã­ã€‚ãƒ¢ãƒƒã‚¯ã¨å®Ÿè£…ãŒå¯†çµåˆã—ã¦ã—ã¾ã†ã¨ã€å¾Œã€…ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ãŸã³ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¦ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã‚’æ¥½ã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãªã®ã«æœ¬æœ«è»¢å€’ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã‚ˆã£ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ãªã©ã€ãƒ¢ãƒƒã‚¯ã—ãªã„ã¨ã„ã‘ãªã„ã‚„ã¤ã ã‘å¯¾è±¡ã«ã—ã¾ã—ã‚‡ã†ã€‚

```tsx
jest.mock("./hooks/subscription", () => ({
  useUserSubscription: jest.fn(),
}));
```

### 5.1.3 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å›ºæœ‰ã®ãƒ¢ãƒƒã‚¯è¨­å®š

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«ã€å¿…è¦ãªãƒ¢ãƒƒã‚¯ã®æˆ»ã‚Šå€¤ã‚„æŒ¯ã‚‹èˆã„ã‚’è¨­å®šã—ã¾ã™ã€‚

### 5.1.4 **ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ&ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ¤œè¨¼**

ä¾å­˜é–¢ä¿‚ã®ãƒ¢ãƒƒã‚¯è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ•ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```tsx
// ãƒ•ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å–å¾—
const { result } = renderHook(() => useCanAccessPremiumFeatures(), { wrapper });
```

ã“ã®æ™‚ã€renderHook ã‚’ä½¿ã‚ãªã„ã¨ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ React ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å¤–ã§å‘¼ã³å‡ºã™ãªã¨æ€’ã‚‰ã‚Œã¾ã™ã€‚

æœ€å¾Œã«ã€ãƒ•ãƒƒã‚¯ã®çµæœãŒæœŸå¾…é€šã‚Šã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ï¼š

```tsx
expect(result.current).toBe(expectedValue);
```

â€»è£œè¶³:

API ãªã©ã®éåŒæœŸå‡¦ç†ãŒãƒ†ã‚¹ãƒˆå¯¾è±¡å†…ã«å­˜åœ¨ã™ã‚‹å ´åˆã€jest ã§æ˜ç¤ºçš„ã«è¿”ã‚Šå€¤ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ã„ã‚‹å ´åˆã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€msw ã‚’ä½¿ã†ãªã©ã—ã¦éåŒæœŸå‡¦ç†ãŒå­˜åœ¨ã—ãŸã¾ã¾ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ã€waitFor ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```tsx
await waitFor(() => {
  expect(result.current).toBe(expectedValue);
});
```

## 5.2 å…·ä½“ä¾‹ï¼šæ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™åˆ¤å®šãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªå¤–éƒ¨ä¾å­˜ã®ã‚ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```tsx
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
 */
export const useFeatureAccessCheck = (): boolean => {
  const userProducts = useUserProductsData();
  const { products } = userProducts;

  // è©¦ç”¨ç‰ˆã®è£½å“ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const hasTrialProduct = Object.values(products).some(
    (product) => product.data?.subscription?.type === SubscriptionType.Trial
  );

  // è©¦ç”¨ç‰ˆã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Œã°æ©Ÿèƒ½ä½¿ç”¨å¯èƒ½
  return hasTrialProduct || hasAvailablePermissions(userProducts);
};
```

**ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ä¾‹:**

```tsx
describe("useFeatureAccessCheck", () => {
  it("è©¦ç”¨ç‰ˆã®è£½å“ãŒã‚ã‚‹å ´åˆã€trueã‚’è¿”ã™", async () => {
    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¢ãƒƒã‚¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - è©¦ç”¨ç‰ˆè£½å“ã‚’è¨­å®š
    mockUserProductsData({
      product1: { type: SubscriptionType.Trial },
    });

    // ãƒ•ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’æ¤œè¨¼
    const { result } = renderHook(() => useFeatureAccessCheck());

    await waitFor(() => {
      expect(result.current).toBe(true);
    });
  });

  it("è©¦ç”¨ç‰ˆè£½å“ãŒãªãã€åˆ©ç”¨å¯èƒ½ãªæ¨©é™ã‚‚ãªã„å ´åˆã€falseã‚’è¿”ã™", async () => {
    mockUserProductsData({
      product1: {
        type: SubscriptionType.Standard,
        permissionLimit: 5,
        usedPermissions: 5,
      },
    });

    // ãƒ•ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’æ¤œè¨¼
    const { result } = renderHook(() => useFeatureAccessCheck());

    await waitFor(() => {
      expect(result.current).toBe(false);
    });
  });
});
```

&nbsp;
&nbsp;
&nbsp;
&nbsp;
ä»¥ä¸Šã§ã™ã€‚
